(window.webpackJsonp=window.webpackJsonp||[]).push([[19],{"5Pwz":function(t,e,n){(t.exports=n("I1BE")(!1)).push([t.i,".buttons .field[data-v-fc0bce56]{margin-bottom:0}.buttons .field.file[data-v-fc0bce56]{margin-right:.5rem}.buttons .field .upload[data-v-fc0bce56]:hover{cursor:pointer}.buttons .field .upload .button[data-v-fc0bce56]{margin-right:0}",""])},AjWS:function(t,e,n){var s=n("5Pwz");"string"==typeof s&&(s=[[t.i,s,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n("aET+")(s,i);s.locals&&(t.exports=s.locals)},Ayc2:function(t,e,n){"use strict";var s=n("AjWS");n.n(s).a},SuVM:function(t,e,n){"use strict";var s=n("7tbW"),i=n.n(s),a={render:function(){return this.$slots.default[0]},inject:["handleClass"],mounted:function(){this.$el.classList.add(this.handleClass)}},r=n("KHd+"),o=Object(r.a)(a,void 0,void 0,!1,null,null,null).exports,l={render:function(){return this.$slots.default[0]},inject:["itemClass"],mounted:function(){this.$el.classList.add(this.itemClass)}},c=Object(r.a)(l,void 0,void 0,!1,null,null,null).exports,u=n("RmOr");function d(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var p={props:{value:{required:!0},itemClass:{default:"sortable-item"},handleClass:{default:"sortable-handle"}},provide:function(){return{itemClass:this.itemClass,handleClass:this.handleClass}},render:function(){return this.$scopedSlots.default({items:this.value})},mounted:function(){var t=this,e=new u.Sortable(this.$el,{draggable:".".concat(this.itemClass),handle:".".concat(this.handleClass),mirror:{constrainDimensions:!0}}).on("sortable:stop",(function(e){var n=e.oldIndex,s=e.newIndex;t.$emit("input",function(t,e,n){var s=[].concat(d(t.slice(0,e)),d(t.slice(e+1,t.length)));return[].concat(d(s.slice(0,n)),[t[e]],d(s.slice(n,s.length)))}(t.value,n,s))}));this.$once("hook:beforeDestroy",(function(){e.destroy()}))}},h={name:"nzColumnsPicker",components:{SortableHandle:o,SortableItem:c,SortableList:Object(r.a)(p,void 0,void 0,!1,null,null,null).exports},props:{value:{type:Array,default:function(){return[]}},columns:{type:Array,required:!0},title:{type:String,default:function(){return"Columns"}}},data:function(){return{allColumns:this.columns,checkedColumns:i()(this.value.concat(this.columns.filter((function(t){return t.required})).map((function(t){return t.value}))))}},computed:{allChecked:function(){return this.checkedColumns.length&&this.checkedColumns.length===this.columns.length},checked:function(){var t=this;return this.allColumns.map((function(t){return t.value})).filter((function(e){return t.checkedColumns.includes(e)}))},required:function(){return this.allColumns.filter((function(t){return t.required}))}},watch:{checked:{immediate:!0,handler:function(){this.$emit("input",this.checked)}}},methods:{checkAll:function(t){t.target.checked?this.checkedColumns=this.allColumns.map((function(t){return t.value})):this.checkedColumns=this.required.map((function(t){return t.value}))}}},m=(n("uDn1"),Object(r.a)(h,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("sortable-list",{staticClass:"columns-picker",scopedSlots:t._u([{key:"default",fn:function(e){var s=e.items;return n("div",{staticClass:"panel"},[n("div",{staticClass:"panel-heading"},[n("b-checkbox",{attrs:{value:t.allChecked},nativeOn:{change:function(e){return t.checkAll(e)}}}),t._v(t._s(t.title)+"\n    ")],1),t._v(" "),t._l(s,(function(e){return n("sortable-item",{key:e.value},[n("div",{staticClass:"panel-block"},[n("b-checkbox",{attrs:{disabled:e.required,required:e.required,"native-value":e.value},model:{value:t.checkedColumns,callback:function(e){t.checkedColumns=e},expression:"checkedColumns"}},[t._v("\n          "+t._s(e.label)+"\n        ")]),t._v(" "),n("sortable-handle",[n("b-icon",{attrs:{icon:"arrows-v",size:"is-small"}})],1)],1)])}))],2)}}]),model:{value:t.allColumns,callback:function(e){t.allColumns=e},expression:"allColumns"}})}),[],!1,null,null,null));e.a=m.exports},WYMz:function(t,e,n){"use strict";var s=n("vDqi"),i=n.n(s),a=n("sEfC"),r=n.n(a),o=n("mwIZ"),l=n.n(o);function c(t){return(c="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var u={name:"nzUserAutocomplete",props:{label:{type:String,default:"User"},placeholder:{type:String,default:"Search for user..."},user:{type:Object,default:null},route:{type:String,default:"api.autocomplete.users.index"},value:{type:String,default:""},error:Boolean,message:{type:String,default:null},except:{},autofocus:Boolean,disabled:Boolean},data:function(){return{data:[],selected:this.user||null,loading:!1}},computed:{icon:function(){return this.selected?"check":null}},watch:{user:function(t){this.selected=t}},methods:{fetchData:r()((function(){var t=this;if(this.value){this.data=[],this.loading=!0;var e={name:this.value};this.except&&(e.except=this.except),i.a.get(route(this.route),{params:e}).then((function(e){e.data.data.forEach((function(e){return t.data.push(e)})),t.loading=!1}),(function(e){t.loading=!1}))}}),500),onSelect:function(t){this.selected=t,this.$emit("select",t)},onInput:function(t){var e=this.getValue(this.selected);e&&e!==t&&this.onSelect(null),this.$emit("input",t),this.fetchData()},focusOnInput:function(){this.$el.querySelector("input").focus()},getValue:function(t){if(t)return"object"===c(t)?l()(t,"full_name"):t}}},d=n("KHd+"),p=Object(d.a)(u,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("b-field",{staticClass:"nz-user-autocomplete",attrs:{label:t.label,type:t.error?"is-danger":null,message:t.message}},[n("b-field",{attrs:{grouped:""}},[n("b-autocomplete",{attrs:{value:t.value,data:t.data,field:"full_name",loading:t.loading,icon:t.icon,placeholder:t.placeholder,expanded:"",autofocus:t.autofocus,disabled:t.disabled},on:{input:t.onInput,select:t.onSelect},scopedSlots:t._u([{key:"default",fn:function(e){return[n("div",{staticClass:"media"},[n("div",{staticClass:"media-content"},[t._v("\n            "+t._s(e.option.full_name)+" "),n("small",[t._v("<"+t._s(e.option.email)+">")])])])]}}])})],1)],1)}),[],!1,null,null,null);e.a=p.exports},Zcvo:function(t,e,n){(t.exports=n("I1BE")(!1)).push([t.i,".columns-picker :focus{outline:none}.columns-picker .panel-block{-webkit-box-pack:justify;justify-content:space-between}.columns-picker .panel-block:hover{cursor:default}.columns-picker .panel-heading{padding-left:.6em}.columns-picker .sortable-handle:hover{cursor:move}.columns-picker .b-checkbox input[type=checkbox][disabled]+.check{opacity:.5}",""])},"c/AF":function(t,e,n){"use strict";n.r(e);var s=n("mwIZ"),i=n.n(s),a=n("WYMz"),r=n("SuVM"),o={name:"nzFieldObservationsImport",components:{NzUserAutocomplete:a.a,NzColumnsPicker:r.a},props:{columns:{type:Array,default:function(){return[]}},initial:{type:Array,default:function(){return[]}},runningImport:Object,cancellableStatuses:{type:Array,default:function(){return[]}},canSubmitForUser:Boolean,canApproveCurated:Boolean},data:function(){return{selectedColumns:this.initial,showColumnsSelection:!1,file:null,importing:!1,currentImport:this.runningImport,validationErrors:[],currentErrorsPage:1,submissionErrors:null,hasHeading:!1,approveCurated:!1,showSuccessMessage:!1,cancelling:!1,userId:null,user:null}},computed:{canSubmit:function(){return!this.importing&&this.file},validationFailed:function(){return"validation_failed"===i()(this.currentImport,"status")},saved:function(){return"saved"===i()(this.currentImport,"status")},savingFailed:function(){return"saving_failed"===i()(this.currentImport,"status")},cancelled:function(){return"cancelled"===i()(this.currentImport,"status")},importStatus:function(){var t=i()(this.currentImport,"status");return this.trans("imports.status.".concat(t))},cancellable:function(){return this.currentImport&&this.cancellableStatuses.includes(this.currentImport.status)&&!this.cancelling},userFullName:function(){return window.App.User.full_name}},created:function(){this.currentImport&&!this.saved&&(this.importing=!0,this.startCheckingStatus())},methods:{toggleColumns:function(){this.showColumnsSelection=!this.showColumnsSelection},submit:function(){this.canSubmit&&(this.resetForm(),this.importing=!0,this.currentImport=null,axios.post("/api/field-observation-imports",this.makeForm()).then(this.handleSuccessfulSubmit).catch(this.handleFailedSubmit))},makeForm:function(){var t=new FormData;return t.append("file",this.file),this.selectedColumns.forEach((function(e){t.append("columns[]",e)})),this.hasHeading&&t.append("has_heading",1),t.append("user_id",this.userId||""),this.approveCurated&&t.append("options[approve_curated]",1),t},resetForm:function(){this.validationErrors=[],this.currentErrorsPage=1,this.showColumnsSelection=!1,this.submissionErrors=null},handleSuccessfulSubmit:function(t){var e=t.data;this.currentImport=e,this.file=null,this.startCheckingStatus()},handleFailedSubmit:function(t){this.importing=!1,this.submissionErrors=i()(t,"response.data.errors",[]),this.$buefy.toast.open({duration:2500,message:i()(t,"response.data.message"),type:"is-danger"})},startCheckingStatus:function(){var t=this;this.interval=setInterval((function(){t.checkStatus()}),2500)},checkStatus:function(){var t=this;return axios.get("/api/field-observation-imports/".concat(this.currentImport.id)).then((function(e){var n=e.data;return t.currentImport=n,t.validationFailed?t.handleFailedValidation():t.savingFailed?t.handleFailedSaving():t.cancelled?t.stopCheckingImport():void(t.saved&&t.handleStored())}))},showValidationErrors:function(){var t=this;return axios.get(this.currentImport.errors_url).then((function(e){var n=e.data;t.validationErrors=n}))},handleFailedValidation:function(){this.$buefy.toast.open({duration:2500,message:this.trans("imports.validation_failed"),type:"is-danger"}),this.showColumnsSelection=!1,this.showValidationErrors(),this.stopCheckingImport()},handleFailedSaving:function(){this.$buefy.toast.open({duration:2500,message:this.trans("imports.saving_failed"),type:"is-danger"}),this.showColumnsSelection=!1,this.stopCheckingImport()},handleStored:function(){this.showSuccessMessage=!0,this.stopCheckingImport()},cancel:function(){var t=this;this.cancellable&&(this.cancelling=!0,axios.post("/api/cancelled-imports",{import_id:this.currentImport.id}).then((function(){t.cancelling=!1,t.stopCheckingImport()})).catch((function(){t.cancelling=!1})))},stopCheckingImport:function(){clearInterval(this.interval),this.importing=!1,this.currentImport=null},setUserId:function(t){this.userId=t?t.id:null}}},l=(n("Ayc2"),n("KHd+")),c=Object(l.a)(o,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"field-observations-import"},[t.importing?n("div",{staticClass:"is-flex is-flex-center flex-col"},[n("div",{staticClass:"is-flex is-flex-center"},[n("span",{staticClass:"loader mr-2"}),t._v(" "),t.currentImport?n("span",{staticClass:"has-loader"},[t._v(t._s(t.importStatus))]):t._e()]),t._v(" "),t.cancellable?n("button",{staticClass:"button is-text has-text-danger",attrs:{type:"button"},on:{click:t.cancel}},[t._v(t._s(t.trans("buttons.cancel")))]):t._e()]):n("div",[n("b-notification",{attrs:{type:"is-success",active:t.showSuccessMessage},on:{"update:active":function(e){t.showSuccessMessage=e}}},[t._v("\n      "+t._s(t.trans("imports.success"))+"\n    ")]),t._v(" "),t.canSubmitForUser?n("nz-user-autocomplete",{attrs:{label:t.trans("labels.imports.user"),placeholder:t.userFullName},on:{select:t.setUserId},model:{value:t.user,callback:function(e){t.user=e},expression:"user"}}):t._e(),t._v(" "),n("div",{staticClass:"level mb-4"},[n("div",{staticClass:"level-left"},[n("div",{staticClass:"level-item"},[n("div",{staticClass:"buttons"},[t.importing?t._e():n("button",{staticClass:"button is-outlined",class:[t.showColumnsSelection?"is-primary":""],attrs:{type:"button"},on:{click:t.toggleColumns}},[t._v(t._s(t.trans("labels.imports.choose_columns")))])])]),t._v(" "),n("div",{staticClass:"level-item"},[t.importing?t._e():n("b-field",{staticClass:"file"},[n("b-upload",{attrs:{accept:".csv"},model:{value:t.file,callback:function(e){t.file=e},expression:"file"}},[n("a",{staticClass:"button"},[n("span",[t._v(t._s(t.trans("labels.imports.select_csv_file")))])])]),t._v(" "),t.file?n("span",{staticClass:"file-name"},[t._v(t._s(t.file.name))]):t._e()],1)],1)]),t._v(" "),n("div",{staticClass:"level-right"},[n("div",{staticClass:"level-item"},[n("button",{staticClass:"button is-primary is-outlined",attrs:{type:"button",disabled:!t.canSubmit},on:{click:t.submit}},[n("b-icon",{attrs:{icon:"upload"}}),t._v(" "),n("span",[t._v(t._s(t.trans("labels.imports.import")))])],1)])])]),t._v(" "),n("b-checkbox",{model:{value:t.hasHeading,callback:function(e){t.hasHeading=e},expression:"hasHeading"}},[t._v(t._s(t.trans("labels.imports.has_heading")))]),t._v(" "),t.canApproveCurated?n("div",[n("b-checkbox",{model:{value:t.approveCurated,callback:function(e){t.approveCurated=e},expression:"approveCurated"}},[t._v(t._s(t.trans("labels.imports.approve_curated")))])],1):t._e()],1),t._v(" "),n("b-collapse",{attrs:{open:t.showColumnsSelection}},[n("nz-columns-picker",{attrs:{columns:t.columns,title:t.trans("labels.imports.columns")},model:{value:t.selectedColumns,callback:function(e){t.selectedColumns=e},expression:"selectedColumns"}})],1),t._v(" "),t.validationErrors.length?n("b-table",{staticClass:"is-danger",attrs:{data:t.validationErrors,paginated:!0,"per-page":30,"current-page":t.currentErrorsPage},on:{"update:currentPage":function(e){t.currentErrorsPage=e},"update:current-page":function(e){t.currentErrorsPage=e}},scopedSlots:t._u([{key:"default",fn:function(e){return[n("b-table-column",{attrs:{field:"row",label:t.trans("labels.imports.row_number")}},[t._v("\n            "+t._s(e.row.row)+"\n        ")]),t._v(" "),n("b-table-column",{attrs:{field:"error",label:t.trans("labels.imports.error")}},[t._v("\n            "+t._s(e.row.error)+"\n        ")])]}}],null,!1,2183879962)}):t._e()],1)}),[],!1,null,"fc0bce56",null);e.default=c.exports},oM3n:function(t,e,n){var s=n("Zcvo");"string"==typeof s&&(s=[[t.i,s,""]]);var i={hmr:!0,transform:void 0,insertInto:void 0};n("aET+")(s,i);s.locals&&(t.exports=s.locals)},uDn1:function(t,e,n){"use strict";var s=n("oM3n");n.n(s).a}}]);
//# sourceMappingURL=19.js.map?id=66888b83246616823fd6